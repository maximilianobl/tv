name: ğŸ“º Sync IPTV Lists

on:
  schedule:
    # Ejecuta diariamente a las 02:00 UTC (puedes cambiar la hora)
    - cron: '0 2 * * *'
  
  # Permite ejecutar manualmente el workflow
  workflow_dispatch:
  
  # Ejecuta cuando se hace push al main branch
  push:
    branches: [ main ]

jobs:
  sync-lists:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“¥ Download Latino Premium List
      run: |
        echo "ğŸ“¡ Descargando lista Latino Premium..."
        curl -s -L "https://raw.githubusercontent.com/ARIEL0202/LATINO-PREMIUM/refs/heads/main/README.md" -o latino-premium-temp.m3u
        
        # Verificar si el archivo se descargÃ³ correctamente
        if [ -f "latino-premium-temp.m3u" ] && [ -s "latino-premium-temp.m3u" ]; then
          echo "âœ… Lista Latino Premium descargada correctamente"
          mv latino-premium-temp.m3u latino-premium.m3u
        else
          echo "âŒ Error al descargar Latino Premium"
          exit 1
        fi
    
    - name: ğŸ“¥ Download TV Premium List  
      run: |
        echo "ğŸ“¡ Descargando lista TV Premium..."
        curl -s -L "https://raw.githubusercontent.com/ARIEL0202/TV-PREMIUM/refs/heads/main/README.md" -o tv-premium-temp.m3u
        
        # Verificar si el archivo se descargÃ³ correctamente
        if [ -f "tv-premium-temp.m3u" ] && [ -s "tv-premium-temp.m3u" ]; then
          echo "âœ… Lista TV Premium descargada correctamente"
          mv tv-premium-temp.m3u tv-premium.m3u
        else
          echo "âŒ Error al descargar TV Premium"
          exit 1
        fi
    
    - name: ğŸ“Š Generate Statistics
      run: |
        echo "ğŸ“ˆ Generando estadÃ­sticas..."
        
        # Contar canales en cada lista
        LATINO_CHANNELS=$(grep -c "^#EXTINF:" latino-premium.m3u || echo "0")
        TV_CHANNELS=$(grep -c "^#EXTINF:" tv-premium.m3u || echo "0")
        TOTAL_CHANNELS=$((LATINO_CHANNELS + TV_CHANNELS))
        
        # Crear archivo de estadÃ­sticas
        cat > STATS.md << EOF
        # ğŸ“Š EstadÃ­sticas de las Listas IPTV
        
        | Lista | Canales | Ãšltima ActualizaciÃ³n |
        |-------|---------|---------------------|
        | Latino Premium | $LATINO_CHANNELS | $(date '+%Y-%m-%d %H:%M:%S UTC') |
        | TV Premium | $TV_CHANNELS | $(date '+%Y-%m-%d %H:%M:%S UTC') |
        | **Total** | **$TOTAL_CHANNELS** | $(date '+%Y-%m-%d %H:%M:%S UTC') |
        
        ## ğŸ“ˆ CategorÃ­as mÃ¡s populares
        
        ### Latino Premium:
        EOF
        
        # Contar categorÃ­as en Latino Premium
        grep 'group-title=' latino-premium.m3u | sed 's/.*group-title="\([^"]*\)".*/\1/' | sort | uniq -c | sort -nr | head -10 >> STATS.md
        
        echo "" >> STATS.md
        echo "### TV Premium:" >> STATS.md
        
        # Contar categorÃ­as en TV Premium  
        grep 'group-title=' tv-premium.m3u | sed 's/.*group-title="\([^"]*\)".*/\1/' | sort | uniq -c | sort -nr | head -10 >> STATS.md
        
        echo "" >> STATS.md
        echo "---" >> STATS.md
        echo "*Ãšltima sincronizaciÃ³n: $(date '+%Y-%m-%d %H:%M:%S UTC')*" >> STATS.md
        
        echo "ğŸ“Š EstadÃ­sticas generadas - Total: $TOTAL_CHANNELS canales"
    
    - name: ğŸ” Check for Changes
      id: changes
      run: |
        # Verificar si hay cambios
        if git diff --quiet HEAD -- latino-premium.m3u tv-premium.m3u STATS.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ No se detectaron cambios en las listas"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Se detectaron cambios en las listas"
          
          # Mostrar un resumen de los cambios
          echo "ğŸ“‹ Resumen de cambios:"
          git diff --stat HEAD -- latino-premium.m3u tv-premium.m3u STATS.md || true
        fi
    
    - name: ğŸ“ Update README with timestamp
      if: steps.changes.outputs.changed == 'true'
      run: |
        # Actualizar README con timestamp
        sed -i "s/{fecha y hora se actualiza automÃ¡ticamente por GitHub Actions}/$(date '+%Y-%m-%d %H:%M:%S UTC')/" README.md
    
    - name: ğŸ’¾ Commit Changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # Agregar archivos modificados
        git add latino-premium.m3u tv-premium.m3u STATS.md README.md
        
        # Crear commit con informaciÃ³n detallada
        LATINO_CHANNELS=$(grep -c "^#EXTINF:" latino-premium.m3u || echo "0")
        TV_CHANNELS=$(grep -c "^#EXTINF:" tv-premium.m3u || echo "0")
        TOTAL_CHANNELS=$((LATINO_CHANNELS + TV_CHANNELS))
        
        git commit -m "ğŸ”„ Auto-sync: Actualizadas listas IPTV
        
        ğŸ“Š Resumen:
        - Latino Premium: $LATINO_CHANNELS canales  
        - TV Premium: $TV_CHANNELS canales
        - Total: $TOTAL_CHANNELS canales
        
        ğŸ• Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')
        ğŸ¤– SincronizaciÃ³n automÃ¡tica via GitHub Actions"
        
        echo "âœ… Cambios committed exitosamente"
    
    - name: ğŸš€ Push Changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "ğŸš€ Haciendo push de los cambios..."
        # Intentar push hasta 3 veces por si hay conflicto
        for i in 1 2 3; do
          if git push origin main; then
            echo "âœ… Push exitoso"
            exit 0
          else
            echo "âš ï¸ Intento $i/3 fallido - Haciendo pull y reintentando..."
            git pull --rebase origin main
            sleep 5
          fi
        done
        echo "âŒ Error: No se pudo hacer push despuÃ©s de 3 intentos"
        exit 1
    
    - name: ğŸ“¨ Create Summary
      run: |
        echo "## ğŸ“º Resumen de SincronizaciÃ³n IPTV" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        LATINO_CHANNELS=$(grep -c "^#EXTINF:" latino-premium.m3u || echo "0")
        TV_CHANNELS=$(grep -c "^#EXTINF:" tv-premium.m3u || echo "0") 
        TOTAL_CHANNELS=$((LATINO_CHANNELS + TV_CHANNELS))
        
        echo "| ğŸ“Š EstadÃ­stica | Valor |" >> $GITHUB_STEP_SUMMARY
        echo "|----------------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ‡±ğŸ‡¦ Latino Premium | $LATINO_CHANNELS canales |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“º TV Premium | $TV_CHANNELS canales |" >> $GITHUB_STEP_SUMMARY  
        echo "| ğŸ¯ **Total** | **$TOTAL_CHANNELS canales** |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ• Ãšltima sync | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "âœ… **Estado**: Listas actualizadas exitosamente" >> $GITHUB_STEP_SUMMARY
        else
          echo "ğŸ“Œ **Estado**: No se requirieron actualizaciones" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Enlaces directos:" >> $GITHUB_STEP_SUMMARY
        echo "- [Latino Premium M3U](https://raw.githubusercontent.com/${{ github.repository }}/main/latino-premium.m3u)" >> $GITHUB_STEP_SUMMARY
        echo "- [TV Premium M3U](https://raw.githubusercontent.com/${{ github.repository }}/main/tv-premium.m3u)" >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ‰ Success Notification
      if: success()
      run: |
        echo "ğŸ‰ Â¡SincronizaciÃ³n completada exitosamente!"
        echo "ğŸ“º Las listas IPTV estÃ¡n actualizadas y listas para usar"
        
    - name: ğŸš¨ Failure Notification  
      if: failure()
      run: |
        echo "ğŸš¨ Error durante la sincronizaciÃ³n"
        echo "âŒ Revisa los logs para mÃ¡s detalles"