name: ğŸ“º Sync IPTV Lists

on:
  schedule:
    # Ejecuta diariamente a las 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write
  actions: read

jobs:
  sync-lists:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ›’ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
    
    - name: ğŸ“¥ Download Latino Premium List
      run: |
        echo "ğŸ“¡ Descargando lista Latino Premium..."
        curl -s -L "https://raw.githubusercontent.com/ARIEL0202/LATINO-PREMIUM/refs/heads/main/README.md" -o latino-premium-temp.m3u
        
        if [ -f "latino-premium-temp.m3u" ] && [ -s "latino-premium-temp.m3u" ]; then
          echo "âœ… Lista Latino Premium descargada correctamente"
          mv latino-premium-temp.m3u latino-premium.m3u
        else
          echo "âŒ Error al descargar Latino Premium"
          exit 1
        fi
    
    - name: ğŸ“¥ Download TV Premium List  
      run: |
        echo "ğŸ“¡ Descargando lista TV Premium..."
        curl -s -L "https://raw.githubusercontent.com/ARIEL0202/TV-PREMIUM/refs/heads/main/README.md" -o tv-premium-temp.m3u
        
        if [ -f "tv-premium-temp.m3u" ] && [ -s "tv-premium-temp.m3u" ]; then
          echo "âœ… Lista TV Premium descargada correctamente"
          mv tv-premium-temp.m3u tv-premium.m3u
        else
          echo "âŒ Error al descargar TV Premium"
          exit 1
        fi
    
    - name: ğŸ“Š Generate Statistics
      run: |
        echo "ğŸ“ˆ Generando estadÃ­sticas..."
        
        # Contar canales en cada lista
        LATINO_CHANNELS=$(grep -c "^#EXTINF:" latino-premium.m3u || echo "0")
        TV_CHANNELS=$(grep -c "^#EXTINF:" tv-premium.m3u || echo "0")
        TOTAL_CHANNELS=$((LATINO_CHANNELS + TV_CHANNELS))
        
        # Crear archivo de estadÃ­sticas
        cat > STATS.md << EOF
        # ğŸ“Š EstadÃ­sticas de las Listas IPTV
        
        | Lista | Canales | Ãšltima ActualizaciÃ³n |
        |-------|---------|---------------------|
        | Latino Premium | $LATINO_CHANNELS | $(date '+%Y-%m-%d %H:%M:%S UTC') |
        | TV Premium | $TV_CHANNELS | $(date '+%Y-%m-%d %H:%M:%S UTC') |
        | **Total** | **$TOTAL_CHANNELS** | $(date '+%Y-%m-%d %H:%M:%S UTC') |
        
        ## ğŸ“ˆ CategorÃ­as mÃ¡s populares
        
        ### Latino Premium:
        \`\`\`
        EOF
        
        # Contar categorÃ­as en Latino Premium
        grep 'group-title=' latino-premium.m3u | sed 's/.*group-title="\([^"]*\)".*/\1/' | sort | uniq -c | sort -nr | head -10 >> STATS.md
        
        cat >> STATS.md << EOF
        \`\`\`
        
        ### TV Premium:
        \`\`\`
        EOF
        
        # Contar categorÃ­as en TV Premium  
        grep 'group-title=' tv-premium.m3u | sed 's/.*group-title="\([^"]*\)".*/\1/' | sort | uniq -c | sort -nr | head -10 >> STATS.md
        
        cat >> STATS.md << EOF
        \`\`\`
        
        ---
        *Ãšltima sincronizaciÃ³n: $(date '+%Y-%m-%d %H:%M:%S UTC')*
        
        ## ğŸ”— Enlaces directos:
        - [Latino Premium M3U](https://raw.githubusercontent.com/${{ github.repository }}/main/latino-premium.m3u)
        - [TV Premium M3U](https://raw.githubusercontent.com/${{ github.repository }}/main/tv-premium.m3u)
        EOF
        
        echo "ğŸ“Š EstadÃ­sticas generadas - Total: $TOTAL_CHANNELS canales"
    
    - name: ğŸ” Check for Changes
      id: changes
      run: |
        if git diff --quiet HEAD -- latino-premium.m3u tv-premium.m3u STATS.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ No se detectaron cambios en las listas"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Se detectaron cambios en las listas"
          
          echo "ğŸ“‹ Resumen de cambios:"
          git diff --stat HEAD -- latino-premium.m3u tv-premium.m3u STATS.md || true
        fi
    
    - name: ğŸ“ Update README timestamp
      if: steps.changes.outputs.changed == 'true'
      run: |
        if [ -f "README.md" ]; then
          # Buscar y reemplazar timestamp en README
          if grep -q "Ãšltima actualizaciÃ³n automÃ¡tica" README.md; then
            sed -i "s/Ãšltima actualizaciÃ³n automÃ¡tica.*$/Ãšltima actualizaciÃ³n automÃ¡tica: $(date '+%Y-%m-%d %H:%M:%S UTC')/" README.md
          fi
        fi
    
    - name: ğŸ’¾ Commit and Push Changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # Agregar archivos
        git add latino-premium.m3u tv-premium.m3u STATS.md README.md
        
        # Generar estadÃ­sticas para el commit
        LATINO_CHANNELS=$(grep -c "^#EXTINF:" latino-premium.m3u || echo "0")
        TV_CHANNELS=$(grep -c "^#EXTINF:" tv-premium.m3u || echo "0")
        TOTAL_CHANNELS=$((LATINO_CHANNELS + TV_CHANNELS))
        
        # Commit con informaciÃ³n detallada
        git commit -m "ğŸ”„ Auto-sync: Actualizadas listas IPTV

        ğŸ“Š Resumen:
        â€¢ Latino Premium: $LATINO_CHANNELS canales  
        â€¢ TV Premium: $TV_CHANNELS canales
        â€¢ Total: $TOTAL_CHANNELS canales
        
        ğŸ• Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')
        ğŸ¤– SincronizaciÃ³n automÃ¡tica via GitHub Actions"
        
        # Push con reintentos
        for i in 1 2 3; do
          if git push origin main; then
            echo "âœ… Push exitoso en intento $i"
            break
          else
            echo "âš ï¸ Intento $i/3 fallido - Reintentando..."
            sleep 5
            if [ $i -eq 3 ]; then
              echo "âŒ Error: No se pudo hacer push despuÃ©s de 3 intentos"
              exit 1
            fi
          fi
        done
    
    - name: ğŸ“¨ Create Summary
      run: |
        echo "## ğŸ“º Resumen de SincronizaciÃ³n IPTV" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        LATINO_CHANNELS=$(grep -c "^#EXTINF:" latino-premium.m3u || echo "0")
        TV_CHANNELS=$(grep -c "^#EXTINF:" tv-premium.m3u || echo "0") 
        TOTAL_CHANNELS=$((LATINO_CHANNELS + TV_CHANNELS))
        
        echo "| ğŸ“Š EstadÃ­stica | Valor |" >> $GITHUB_STEP_SUMMARY
        echo "|----------------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ‡±ğŸ‡¦ Latino Premium | $LATINO_CHANNELS canales |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“º TV Premium | $TV_CHANNELS canales |" >> $GITHUB_STEP_SUMMARY  
        echo "| ğŸ¯ **Total** | **$TOTAL_CHANNELS canales** |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ• Ãšltima sync | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "âœ… **Estado**: Listas actualizadas exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ **AcciÃ³n**: Se detectaron cambios y se actualizÃ³ el repositorio" >> $GITHUB_STEP_SUMMARY
        else
          echo "ğŸ“Œ **Estado**: No se requirieron actualizaciones" >> $GITHUB_STEP_SUMMARY
          echo "â¸ï¸ **AcciÃ³n**: Las listas ya estaban actualizadas" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Enlaces directos:" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“º Latino Premium M3U](https://raw.githubusercontent.com/${{ github.repository }}/main/latino-premium.m3u)" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ¬ TV Premium M3U](https://raw.githubusercontent.com/${{ github.repository }}/main/tv-premium.m3u)" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“Š EstadÃ­sticas](https://github.com/${{ github.repository }}/blob/main/STATS.md)" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Top 5 categorÃ­as mÃ¡s populares:" >> $GITHUB_STEP_SUMMARY
        echo "**Latino Premium:**" >> $GITHUB_STEP_SUMMARY
        grep 'group-title=' latino-premium.m3u | sed 's/.*group-title="\([^"]*\)".*/\1/' | sort | uniq -c | sort -nr | head -5 | while read count category; do
          echo "- $category: $count canales" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**TV Premium:**" >> $GITHUB_STEP_SUMMARY
        grep 'group-title=' tv-premium.m3u | sed 's/.*group-title="\([^"]*\)".*/\1/' | sort | uniq -c | sort -nr | head -5 | while read count category; do
          echo "- $category: $count canales" >> $GITHUB_STEP_SUMMARY
        done
    
    - name: ğŸ‰ Success Notification
      if: success()
      run: |
        echo "ğŸ‰ Â¡SincronizaciÃ³n completada exitosamente!"
        echo "ğŸ“º Las listas IPTV estÃ¡n actualizadas y listas para usar"
        
    - name: ğŸš¨ Failure Notification  
      if: failure()
      run: |
        echo "ğŸš¨ Error durante la sincronizaciÃ³n"
        echo "âŒ Revisa los logs para mÃ¡s detalles"